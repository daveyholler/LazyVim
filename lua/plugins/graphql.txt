-- ~/.config/nvim/lua/plugins/rest.lua
-- rest.nvim configuration for LazyVim

return {
  {
    "rest-nvim/rest.nvim",
    dependencies = { 
      "nvim-lua/plenary.nvim",
      "nvim-treesitter/nvim-treesitter", 
    },
    ft = "http",
    config = function()
      require("rest-nvim").setup({
        -- Open request results in a horizontal split
        result_split_horizontal = false,
        -- Open request results in a vertical split  
        result_split_in_place = false,
        -- Keep the http file buffer above|left when split horizontal|vertical
        stay_in_current_window_after_split = true,
        -- Skip SSL verification, useful for unknown certificates
        skip_ssl_verification = false,
        -- Encode URL before making request
        encode_url = true,
        -- Highlight request on run
        highlight = {
          enabled = true,
          timeout = 150,
        },
        result = {
          -- Toggle showing URL, HTTP info, headers at top of result window
          show_url = true,
          show_http_info = true, 
          show_headers = true,
          -- Formatters for different content types
          formatters = {
            json = "jq",
            html = function(body)
              if vim.fn.executable("tidy") == 1 then
                return vim.fn.system({"tidy", "-i", "-q", "-"}, body)
              end
              return body
            end
          },
        },
        -- Jump to request line on run
        jump_to_request = false,
        env_file = '.env',
        custom_dynamic_variables = {},
        yank_dry_run = true,
      })
    end,
    keys = {
      { "<leader>rr", "<cmd>Rest run<cr>", desc = "Run REST request", ft = "http" },
      { "<leader>rl", "<cmd>Rest run last<cr>", desc = "Re-run last request" },
      { "<leader>rp", "<cmd>Rest logs<cr>", desc = "Show request logs" },
      { "<leader>re", "<cmd>Rest env show<cr>", desc = "Show environment variables" },
    },
  },

  -- File type detection for HTTP files
  {
    "nvim-treesitter/nvim-treesitter",
    opts = function(_, opts)
      if type(opts.ensure_installed) == "table" then
        vim.list_extend(opts.ensure_installed, { "http" })
      end
    end,
    config = function()
      vim.filetype.add({
        extension = {
          http = "http",
          rest = "http",
        },
      })
    end,
  },
}
